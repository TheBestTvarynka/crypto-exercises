# Sensitive information storage

### General info

Backend та Frontend я взяв із минулої лобораторної роботи. У цій лабораторній роботі я вирішив шифрувати наступні дані:

* username
* full name
* email

(пароль хешується та шифрується за замовчуванням, тому у цьому списку його не вказував)

### How I encrypt the data

Для усіх даних, які я шифрую, використовується алгоритма `xsalsa20` із заданим ключем та випадковим nonce. nonce генерується за допомогою функції `randomBytes` із стандартного можуля `crypto`. Ця функція є криптографічнобезпечною.
Ключ береться із змінної середовища.

### How I implement it

Враховуючи те, що я використовую код із минулих проектів/лабораторних, то я хотів би змінювати чим менше коду,але при цьому додати шифрування для важливих даних. У коді є виклики до бд, діставання конекшина із пула і тд. Нприклад:

```js
const client = await this.connectionPool.connect();
client.query(...);
client.release();
```

Я написав свій клас, який є обгорткою над `Pool, PoolClient` і має такий самий контракт, як і вони. Тепер я просто к конструкторі підміню `Pool` & `PoolClient` та свою обгортку. Для чого це? Просто в середині обгортки я шифруватиму дані. В результаті основний код не змінився (тільки конструктор) + я можу шифрувати дані.
Тепер потрібно придумати як шифрувати дані. Не все, що потрапляє у запит, потрібно шифрувати. В моїй поточній реалізації це виглядає ось так:

```js
await client.query('insert into users values ($1, $2, $3, $4, $5)', [
  user.id,                                     // do not encrypt
  { value: user.username, isEncrypted: true }, // encrypt username
  { value: user.email, isEncrypted: true },
  { value: user.fullName, isEncrypted: true },
  { value: user.password, isEncrypted: false } // do not encrypt. the same as just `user.password`
]);
```
Якщо коротко, то якщо опція `isEncrypted` явно сказана, то тоді шифрується. В усіх інших випадках - ні.

Для розшифровування ми теж повинні вказати, які колонки мають бути розшифровані. Приклад:

```js
const decryptedUser = decryptRow(user, { fullName: true, username: true, email: true });
```

Першим параметром передаємо об'єкт, поля якого треба розшифрувати. Другим параметром схему - тобто які поля реально потрібно розшифрувати.

